<?xml version="1.0" encoding= "UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="milestones">
    <insert id="saveMilestone" parameterType="com.nbreds.projectPlanning.milestones.VO.Milestone">
    <![CDATA[
	  insert into Milestones (
	  mtitle
	  ,mdescription
	  ,mduedate
	  ,pno
	) VALUES (
	  #{mtitle}
	  ,#{mdescription}
	  ,#{mduedate}
	  ,#{pno}
	)
    ]]>  
    </insert>
    
    <select id="getMilestonesByPno" parameterType="hashmap" resultType="com.nbreds.projectPlanning.milestones.VO.Milestone">
    <![CDATA[
    select mno, mtitle, mduedate, mstatement FROM Milestones
	where pno=#{pno}
	]]>
	<if test="mstatement != null">
	and mstatement=#{mstatement}
	</if>
	<![CDATA[
	order by mno desc  
	]]>
    </select>
    
    <select id="getMilestoneBymno" parameterType="int" resultType="com.nbreds.projectPlanning.milestones.VO.Milestone">
    <![CDATA[
    SELECT M.mno, M.mtitle, M.mdescription, M.mduedate, M.mstatement, M.pno, U.uname, P.pname 
	FROM Project P inner join Milestones M on M.pno = P.pno
		             inner join User U on P.uno = U.uno
	WHERE mno=#{mno}
	ORDER BY mno DESC
	]]>
    </select>
    
    <update id="editMilestoneBymno" parameterType="com.nbreds.projectPlanning.milestones.VO.Milestone">
    <![CDATA[
	   UPDATE Milestones SET
	  mtitle = #{mtitle}
	  ,mdescription = #{mdescription}
	  ,mduedate = #{mduedate}
	WHERE mno = #{mno}
	]]> 
    </update>
    
    <delete id="removeMilestone" parameterType="int">
    <![CDATA[
    delete from Milestones where mno = #{mno};
    ]]>  
    </delete>
    
    <update id="closeMilestone" parameterType="int">
    <![CDATA[
	   UPDATE Milestones SET
	  mstatement = "001"
	WHERE mno = #{mno}
	]]> 
    </update>
    
    <update id="reopenMilestone" parameterType="int">
    <![CDATA[
	   UPDATE Milestones SET
	  mstatement = "000"
	WHERE mno = #{mno}
	]]> 
    </update>
    
    <select id="getJoinMilestones" parameterType="hashmap" resultType="com.nbreds.projectPlanning.milestones.VO.Milestone">
    <![CDATA[
    SELECT M.mno, M.mtitle, M.mstatement, M.mduedate, U.uname, P.pname
	FROM Project P inner join Milestones M on M.pno = P.pno
	             inner join User U on P.uno = U.uno
	WHERE 
	]]>
	<if test="mstatement != null">
	M.mstatement=#{mstatement} AND 
	</if>
	<![CDATA[
	(P.pmember like '%' #{uno} '%' OR P.uno = #{uno})
	ORDER BY M.mno DESC
	]]> 
    </select>
    
    <select id="getPnameByPno" parameterType="int" resultType="String">
    <![CDATA[
    select pname FROM Project
	where pno=#{pno}
	]]>
    </select>
    
    <select id="getUnameByUno" parameterType="String" resultType="String">
    <![CDATA[
    select uname FROM User
	where uno=#{uno}
	]]>
    </select>
    
    <select id="countIssuesByMno" parameterType="int" resultType="int">
    <![CDATA[
    SELECT COUNT(ino)
	FROM Issues
	WHERE mno=#{mno}
	]]>
    </select>
    
    <select id="countClosedIssueByMno" parameterType="int" resultType="int">
    <![CDATA[
    SELECT COUNT(ino)
	FROM Issues
	WHERE mno=#{mno} and istatement=001
	]]>
    </select>
    
    <select id="countOpenIssuesByMno" parameterType="int" resultType="int">
    <![CDATA[
    SELECT COUNT(ino)
	FROM Issues
	WHERE mno=#{mno} and istatement=000
	]]>
    </select>
    
    <select id="getIssuesBymno" parameterType="int" resultType="com.nbreds.projectPlanning.issues.VO.Issue">
    <![CDATA[
    SELECT ino, ititle, istatement, mno, pno, uno 
    FROM Issues
	WHERE mno = #{mno}
	]]>
    </select>
    
    <update id="editIssueByIno" parameterType="hashmap">
    <![CDATA[
	UPDATE Issues SET
	  istatement = #{istatement}
	]]>
	<if test="uno != null">
	  ,uno = #{uno}
	</if>
	<![CDATA[
	WHERE ino = #{ino}
	]]>
    </update>
</mapper>